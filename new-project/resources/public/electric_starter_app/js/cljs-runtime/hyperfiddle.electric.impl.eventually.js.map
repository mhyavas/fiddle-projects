{"version":3,"sources":["hyperfiddle/electric/impl/eventually.cljc"],"mappings":";AAGA,AAAA;;;;;;;;;;;;;;AAAA,AAAA,CAAA,AAAA,yDAAA,WAAAA,pEAASU;;AAAT,AAAA,IAAAT,SAAA;AAAA,AAAA,IAAAC,WAAA,CAAA,AAAA,mBAAA;AAAA,AAAA,QAAAA;KAAA;AAAA,OAAAD;;;;AAAA,MAAA,KAAAE,MAAA,CAAA,8DAAA,CAAA,AAAA,mBAAA;;;;;AAAA,CAAA,AAAA,0DAAA,WAAAF,OAAAG,5EAASM;;AAAT,AAAA,IAAAT,aAAA;AAAA,AAAA,OAAA,AAAAA,sBAAAA,WAAA,AAAA,CAAAA,mBAAA,AAAAI,iBAAAD;;;AAAA,CAAA,AAAA,kFAAA,lFAASM;;AAAT,AAAA,QAAA,JAEkCM;AAFlC,AAGI,IAAAC,eAAC,CAAMF,aAAM,CAAA,MAAA;AAAb,AAAA,QAAAE,6CAAAA,+CAAAA;;;AAHJ,CAAA,AAAA,oFAAA,pFAASP,+FAKuBQ;;AALhC,AAAA,aAAA,TAKgCA;AALhC,AAMI,AACE,GAAI,gCAAA,/BAAM,CAAMH,aAAM,CAAA,MAAA;AACpB,AAAI,CAACD,kDAAAA,oDAAAA;;AAAYF;;AACjB,IAAA,AAAK,6BAAA,5BAAMG,aAAM,CAAA,MAAA;;AACZ,QAAA,AAAAK,JAAMC,oBAAG,CAAMN,aAAM,CAAA,MAAA;AAArB,AACE,GAAI,gCAAA,/BAAM,CAAMA,aAAM,CAAA,MAAA;AACpB,CAAMA,aAAM,CAAA,MAAA,QAAQF;;AACpB,AAAI,6BAAA,5BAAME,aAAM,CAAA,MAAA;;AACZ,CAACF,gDAAAA,kDAAAA;;;AAAYQ;gBAL1B,QAAAF,JAM8CG;AAN9C,AAOO,GAAI,gCAAA,/BAAM,CAAMP,aAAM,CAAA,MAAA;AACpB,CAAMA,aAAM,CAAA,MAAA,QAAQD;;AACpB,AAAI,6BAAA,5BAAMC,aAAM,CAAA,MAAA;;AACZ,CAACD,kDAAAA,oDAAAA;;;AAAc,MAAOQ;;;;AAnB3C,CAAA,mDAAA,nDAASZ;AAAT,AAAA,AAAA;;;AAAA,CAAA,yDAAA,zDAASA;;AAAT,CAAA,4DAAA,5DAASA;;AAAT,CAAA,iEAAA,WAAAJ,mBAAAC,qBAAAC,pHAASE;AAAT,AAAA,OAAAD,iBAAAF,qBAAA;;;AAAA;;;+CAAA,/CAASI,sGAAIC,OAAMC,SAASC,WAAoBC;AAAhD,AAAA,YAAAL,wCAAaE,OAAMC,SAASC,WAAoBC;;;AAAvCL,AAqBT;;;;kDAAA,lDAAMa,4GAEHF,EAAEG;AAFL,AAGE,kBAAKC,EAAEC;AAAP,AACE,IAAMX,QAAM,qDAAA,rDAACY;IACPT,KAAG,AAACP,6CAAKU,EAAEI,EAAEC,EAAEX;AADrB,AAEE,AACE,CAAMA,MAAM,CAAA,MAAA,QAAQU;;AACpB,CAAMV,MAAM,CAAA,MAAA,QACV,iBAAAa,WAAGH;IAAHI,WAAA;AAAA,AAAM,AACE,IAAAC,qBAAa,CAAMf,MAAM,CAAA,MAAA;AAAzB,AAAA,GAAA,CAAAe,sBAAA;AAEE,QAAMf,MAAM,CAAA,MAAA,QAAQG;;AAFtB,SAAAY,LAAUC;AAAV,AACE,AAAI,sBAAA,rBAAMhB,MAAM,CAAA,MAAA;;AAAa,QAACgB,mCAAAA,qCAAAA;;;AAFxC,AAAA,0EAAAH,SAAAC,wBAAAD,SAAAC,5GAACL,kCAAAA,qDAAAA;;;AAGqCN","names":["unused__18786__auto__","self__","G__47569","js/Error","args47568","cljs.core/aclone","this__5283__auto__","writer__5284__auto__","opt__5285__auto__","cljs.core/-write","hyperfiddle.electric.impl.eventually/It","hyperfiddle.electric.impl.eventually/->It","final","notifier","terminator","state","_","fexpr__47579","it","e47581","cljs.core/deref","x","e","hyperfiddle.electric.impl.eventually/eventually","f","n","t","cljs.core.object_array","G__47590","G__47591","temp__5818__auto__","cb"],"sourcesContent":["(ns hyperfiddle.electric.impl.eventually\r\n  #?(:clj (:import (clojure.lang IFn IDeref))))\r\n\r\n(deftype It [final notifier terminator ^objects state]\r\n  IFn\r\n  (#?(:clj invoke :cljs -invoke) [_]\r\n    ((aget state (int 0))))\r\n  IDeref\r\n  (#?(:clj deref :cljs -deref) [it]\r\n    (locking it\r\n      (if (nil? (aget state (int 1)))\r\n        (do (terminator) final)\r\n        (try (aset state (int 1) nil)\r\n             (let [x @(aget state (int 0))]\r\n               (if (nil? (aget state (int 1)))\r\n                 (aset state (int 1) notifier)\r\n                 (do (aset state (int 1) nil)\r\n                     (notifier))) x)\r\n             (catch #?(:clj Throwable :cljs :default) e\r\n               (if (nil? (aget state (int 1)))\r\n                 (aset state (int 1) terminator)\r\n                 (do (aset state (int 1) nil)\r\n                     (terminator))) (throw e)))))))\r\n\r\n(defn eventually \"\r\nReturns a flow producing successive values of given flow, followed by given value if it terminates successfully.\r\n\" [x f]\r\n  (fn [n t]\r\n    (let [state (object-array 2)\r\n          it (->It x n t state)]\r\n      (locking it\r\n        (aset state (int 1) n)\r\n        (aset state (int 0)\r\n          (f n #(locking it\r\n                  (if-some [cb (aget state (int 1))]\r\n                    (do (aset state (int 1) nil) (cb))\r\n                    (aset state (int 1) it))))) it))))"],"x_google_ignoreList":[0]}